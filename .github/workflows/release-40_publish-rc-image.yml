name: Release - Publish RC Container image
# see https://github.com/paritytech/release-engineering/issues/97#issuecomment-1651372277

on:
  workflow_dispatch:
    inputs:
      release_id:
        description: 'Release ID'
        required: true
        type: string
        # TODO: to be removed, this eases testing
        default: "62185729"
      registry:
        description: "Container registry"
        required: true
        type: string
        default: docker.io
      owner:
        description: Owner of the container image repo
        required: true
        type: string
        default: parity

env:
  RELEASE_ID: ${{ inputs.release_id }}
  ENGINE: docker
  REGISTRY: ${{ inputs.registry }}
  GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
  DOCKER_OWNER: ${{ inputs.owner || github.repository_owner }}
  REPO: ${{ github.repository }}

jobs:
  fetch-artifacts:
    runs-on: ubuntu-latest

    steps:
      - name: Checkout sources
        uses: actions/checkout@v3

      - name: Fetch all artifacts
        run: |
          . ./scripts/ci/common/lib.sh
          fetch_release_artifacts

      - name: Cache the artifacts
        uses: actions/cache@88522ab9f39a2ea568f7027eddc7d8d8bc9d59c8 # v3.3.1
        with:
          key: artifacts-${{ github.sha }}
          path: |
            artifacts/**/*

  build-container:
    runs-on: ubuntu-latest
    needs: fetch-artifacts

    strategy:
      matrix:
        binary: ["polkadot", "staking-miner"]

    steps:
      - name: Checkout sources
        uses: actions/checkout@v3

      - name: Get artifacts from cache
        uses: actions/cache@88522ab9f39a2ea568f7027eddc7d8d8bc9d59c8 # v3.3.1
        with:
          key: artifacts-${{ github.sha }}
          path: |
            artifacts/**/*

      - name: Check sha256 ${{ matrix.binary }}
        working-directory: ./artifacts
        run: |
          . ../scripts/ci/common/lib.sh

          echo "Checking binary ${{ matrix.binary }}"
          check_sha256 ${{ matrix.binary }} && echo "OK" || echo "ERR"

      # - name: Check GPG ${{ matrix.binary }}
      #   working-directory: ./artifacts
      #   run: |
      #     . ../scripts/ci/common/lib.sh
      #     # TODO import relevant GPG keys
      #     check_gpg ${{ matrix.binary }}

      - name: Fetch commit and tag
        id: fetch_refs
        run: |
          release=release-${{ inputs.release_id }}
          commit=$(git rev-parse --short HEAD)
          tag=$(git name-rev --tags --name-only $(git rev-parse HEAD))

          echo "release=${release}" >> $GITHUB_OUTPUT
          echo "commit=${commit}" >> $GITHUB_OUTPUT
          echo "tag=${tag}" >> $GITHUB_OUTPUT
          echo "tag=${tag}" >> $GITHUB_OUTPUT

      - name: Build Injected Container image for ${{ matrix.binary }}
        env:
            BIN_FOLDER: artifacts
            BINARY: ${{ matrix.binary }}
            TAGS: ${{join(steps.fetch_refs.outputs.*, ',')}}
        run: |
          echo "Building container for ${{ matrix.binary }}"
          ./scripts/ci/dockerfiles/build-injected.sh

      - name: Login to Dockerhub
        uses: docker/login-action@v2
        with:
          username: ${{ inputs.owner }}
          password: ${{ secrets.DOCKERHUB_TOKEN }}

      - name: Push Container image for ${{ matrix.binary }}
        id: docker_push
        env:
          BINARY: ${{ matrix.binary }}
        run: |
          $ENGINE push --all-tags ${REGISTRY}/${DOCKER_OWNER}/${BINARY}
